name: CI-CD Pipeline

on:
  push:
    branches: [ main ]

jobs:

  build_test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm ci
          echo "✅ Dependencias instaladas correctamente"

      - name: Run lint
        run: |
          npx eslint . --max-warnings=0 --config .eslintrc.json
          echo "✅ Lint completado"

      - name: Run tests
        run: |
          npm test -- --coverage
          echo "✅ Tests ejecutados con éxito"
          if [ -f coverage/lcov-report/index.html ]; then
            echo "Cobertura de tests generada"
          else
            echo "No se encontró reporte de cobertura"
          fi

  generate_docs:
    runs-on: ubuntu-latest
    needs: build_test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate documentation
        run: |
          npx jsdoc -c jsdoc.json
          echo "✅ Documentación generada"
          if [ -d docs ]; then
            tree docs
          else
            echo "No se pudo listar la documentación"
          fi

      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: docs
          path: docs

      - name: Upload README artifact
        uses: actions/upload-artifact@v4
        with:
          name: readme
          path: README.md

  deploy_canary:
    runs-on: ubuntu-latest
    needs: generate_docs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build project
        run: |
          npm run build
          echo "✅ Build generado correctamente"
          ls -lah dist

      - name: Start containers
        run: |
          docker-compose up -d
          echo "✅ Contenedores levantados"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

      - name: Canary deploy
        run: |
          echo "Iniciando despliegue canario..."
          sleep 2
          echo "Desplegando al 10% de tráfico"
          sleep 1
          echo "Monitoreando métricas: requests, errores, latencia"
          sleep 1
          echo "Despliegue canario completado, incrementando al 100%"
          sleep 1
          echo "✅ Canary deployment finalizado"

      - name: Validate health
        run: |
          STATUS=$(curl -s http://localhost:8080/health)
          echo "Health check response: $STATUS"
          if [[ "$STATUS" != *"ok"* ]]; then
            echo "❌ Servicio no saludable"
            exit 1
          fi
          echo "✅ Servicio saludable"

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Rollback activado por fallo"
          docker-compose down
          docker-compose up -d previous-version
          echo "✅ Rollback completado"
