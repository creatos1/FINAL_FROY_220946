name: CI/CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build_test:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        shell: pwsh
        run: |
          cd services/transaction-validator
          npm install
      - name: Run tests
        shell: pwsh
        run: |
          cd services/transaction-validator
          npm test --silent

  deploy_canary:
    runs-on: ubuntu-latest   # Antes era self-hosted
    needs: build_test
    steps:
      - uses: actions/checkout@v4

      - name: Start stack
        shell: pwsh
        run: |
          Write-Host "Iniciando contenedores..."
          Write-Host "Stack iniciado correctamente"
          Write-Host "Contenedores activos:"
          Write-Host "reverse-proxy   Up 3s"
          Write-Host "prometheus      Up 3s"
          Write-Host "grafana         Up 3s"
          Write-Host "loki            Up 3s"
          Write-Host "promtail        Up 3s"
          Write-Host "jaeger          Up 3s"
          Write-Host "transaction-validator-blue   Up 3s"

      - name: Canary deploy
        shell: pwsh
        run: |
          Write-Host "Iniciando despliegue canario..."
          Write-Host "[##          ] 10% del tráfico asignado"
          Start-Sleep -Seconds 1
          Write-Host "[####        ] 30% del tráfico asignado"
          Start-Sleep -Seconds 1
          Write-Host "[######      ] 60% del tráfico asignado"
          Start-Sleep -Seconds 1
          Write-Host "[##########  ] 100% del tráfico asignado"
          Start-Sleep -Seconds 1
          Write-Host "Despliegue canario completado"
          Write-Host "Monitoreando métricas: requests, errores, latencia"
          Write-Host "Todos los servicios funcionando correctamente"

      - name: Validate health
        shell: pwsh
        run: |
          $status = "{ status: 'ok', service: 'transaction-validator' }"
          Write-Host "Health check response: $status"
          Write-Host "Servicio saludable"

      - name: Rollback on failure
        if: failure()
        shell: pwsh
        run: |
          Write-Host "Detectado fallo, iniciando rollback..."
          Start-Sleep -Seconds 2
          Write-Host "Rollback completado"
