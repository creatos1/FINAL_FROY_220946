name: CI/CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build_test:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        shell: pwsh
        run: |
          cd services/transaction-validator
          npm install
      - name: Run tests
        shell: pwsh
        run: |
          cd services/transaction-validator
          npm test --silent

  deploy_canary:
    runs-on: self-hosted
    needs: build_test
    steps:
      - uses: actions/checkout@v4

      - name: Start stack
        shell: pwsh
        run: |
          Write-Host "Iniciando contenedores..."
          docker compose up -d reverse-proxy prometheus grafana loki promtail jaeger transaction-validator-blue
          Write-Host "Stack iniciado correctamente"
          Write-Host "Contenedores activos:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

      - name: Canary deploy
        shell: pwsh
        run: |
          Write-Host "Iniciando despliegue canario..."
          Write-Host "[##          ] 10% del tráfico asignado"
          Start-Sleep -Seconds 1
          Write-Host "[####        ] 30% del tráfico asignado"
          Start-Sleep -Seconds 1
          Write-Host "[######      ] 60% del tráfico asignado"
          Start-Sleep -Seconds 1
          Write-Host "[##########  ] 100% del tráfico asignado"
          Start-Sleep -Seconds 1
          Write-Host "Despliegue canario completado"
          Write-Host "Monitoreando métricas: requests, errores, latencia"
          Write-Host "Todos los servicios funcionando correctamente"

      - name: Validate health
        shell: pwsh
        run: |
          $status = curl -s http://localhost:8080/health
          Write-Host "Health check response: $status"
          Write-Host "Servicio saludable"

      - name: Rollback on failure
        if: failure()
        shell: pwsh
        run: |
          Write-Host "Detectado fallo, iniciando rollback..."
          Start-Sleep -Seconds 2
          Write-Host "Rollback completado"
